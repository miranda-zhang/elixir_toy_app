# Cross-Origin Resource Sharing
If frontend deployed on a host different from backend. 
## Solution 1: Add CORS Plug to Your Endpoint

### Step 1: Add CORS Plug dependency

Add `cors_plug` to your `mix.exs`:

```elixir
defp deps do
  [
    # ... existing dependencies
    {:cors_plug, "~> 3.0"}
  ]
end
```

Then run:
```bash
mix deps.get
```

### Step 2: Configure CORS in your Endpoint

Update your `lib/backend_web/endpoint.ex`:

```elixir
defmodule BackendWeb.Endpoint do
  use Phoenix.Endpoint, otp_app: :backend

  # Add CORS plug before other plugs
  plug CORSPlug,
    origin: [
      "http://localhost:5173",
      "http://localhost:3000",
      "http://127.0.0.1:5173",
      "http://127.0.0.1:3000",
      # Add your production frontend URL here when deployed
      "https://miranda-zhang.github.io"
    ],
    credentials: true,
    methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
    headers: [
      "Authorization",
      "Content-Type",
      "Accept",
      "Origin",
      "User-Agent",
      "DNT",
      "Cache-Control",
      "X-Requested-With",
      "X-CSRF-Token"
    ],
    max_age: 86400

  # The session will be stored in the cookie and signed,
  # this means its contents can be read but not tampered with.
  # Set :encryption_salt if you would also like to encrypt it.
  @session_options [
    store: :cookie,
    key: "_backend_key",
    signing_salt: "UQudmnAs",
    same_site: "Lax"
  ]

  socket "/live", Phoenix.LiveView.Socket,
    websocket: [connect_info: [session: @session_options]],
    longpoll: [connect_info: [session: @session_options]]

  # Serve at "/" the static files from "priv/static" directory.
  #
  # When code reloading is disabled (e.g., in production),
  # the `gzip` option is enabled to serve compressed
  # static files generated by running `phx.digest`.
  plug Plug.Static,
    at: "/",
    from: :backend,
    gzip: not code_reloading?,
    only: BackendWeb.static_paths()

  # Code reloading can be explicitly enabled under the
  # :code_reloader configuration of your endpoint.
  if code_reloading? do
    plug Phoenix.CodeReloader
    plug Phoenix.Ecto.CheckRepoStatus, otp_app: :backend
  end

  plug Phoenix.LiveDashboard.RequestLogger,
    param_key: "request_logger",
    cookie_key: "request_logger"

  plug Plug.RequestId
  plug Plug.Telemetry, event_prefix: [:phoenix, :endpoint]

  plug Plug.Parsers,
    parsers: [:urlencoded, :multipart, :json],
    pass: ["*/*"],
    json_decoder: Phoenix.json_library()

  plug Plug.MethodOverride
  plug Plug.Head
  plug Plug.Session, @session_options
  plug BackendWeb.Router
end
```

## Solution 2: Environment-Specific CORS Configuration

For better security, configure different CORS settings for different environments:

### Update `config/config.exs`:

```elixir
import Config

# General CORS configuration
config :backend, :cors_origins, [
  "http://localhost:5173",
  "http://localhost:3000",
  "http://127.0.0.1:5173",
  "http://127.0.0.1:3000"
]

# ... rest of your config
```

### Update `config/dev.exs`:

```elixir
import Config

config :backend, :cors_origins, [
  "http://localhost:5173",
  "http://localhost:3000", 
  "http://127.0.0.1:5173",
  "http://127.0.0.1:3000",
  "http://localhost:5174" # Add any other dev URLs
]
```

### Update `config/prod.exs`:

```elixir
import Config

# Add your production frontend URLs here
config :backend, :cors_origins, [
  "https://your-production-frontend.com",
  "https://www.your-production-frontend.com"
]
```

### Update your endpoint to use the config:

```elixir
defmodule BackendWeb.Endpoint do
  use Phoenix.Endpoint, otp_app: :backend

  # Get CORS origins from config
  @cors_origins Application.compile_env(:backend, :cors_origins, [])

  plug CORSPlug,
    origin: @cors_origins,
    credentials: true,
    methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
    headers: [
      "Authorization",
      "Content-Type", 
      "Accept",
      "Origin",
      "User-Agent",
      "DNT",
      "Cache-Control",
      "X-Requested-With",
      "X-CSRF-Token"
    ],
    max_age: 86400

  # ... rest of your endpoint code
end
```

## Solution 3: For Development - Allow All Origins (Temporary)

If you're just testing and want to allow all origins temporarily:

```elixir
defmodule BackendWeb.Endpoint do
  use Phoenix.Endpoint, otp_app: :backend

  # Allow all origins in development (remove in production!)
  if Mix.env() == :dev do
    plug CORSPlug, 
      origin: "*",
      methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
      headers: :all
  else
    # Production CORS configuration
    plug CORSPlug,
      origin: ["https://your-production-domain.com"],
      credentials: true,
      methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
      headers: [
        "Authorization", 
        "Content-Type",
        "Accept",
        "Origin"
      ]
  end

  # ... rest of your endpoint code
end
```

## Deploy the Changes

After making these changes:

1. **Commit your changes:**
```bash
git add .
git commit -m "Add CORS configuration"
```

2. **Deploy to Render:**
```bash
git push origin main
```

## Testing the Fix

Once deployed, your frontend should now be able to make requests to the backend without CORS errors. The response should include the proper CORS headers:

```
Access-Control-Allow-Origin: http://localhost:5173
Access-Control-Allow-Credentials: true
Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS
Access-Control-Allow-Headers: Authorization, Content-Type, Accept, Origin, User-Agent, DNT, Cache-Control, X-Requested-With, X-CSRF-Token
```

## Recommended Approach

I recommend **Solution 1** (adding CORS plug to endpoint) with **Solution 3** (environment-specific configuration) for the best balance of security and functionality. This will:

- ✅ Fix your immediate CORS issue
- ✅ Allow your Vite dev server to communicate with the backend
- ✅ Provide proper security in production
- ✅ Be maintainable and configurable

After implementing this, restart your Phoenix server and your frontend should work without CORS errors!